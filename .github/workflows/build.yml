name: C++ CI Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    
    strategy:
      matrix:
        build_type: [Debug, Release]
        
    steps:
    - name: 🔍 Checkout código
      uses: actions/checkout@v4
      
    - name: 🔧 Setup MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-gdb
          make
          
    - name: 📋 Informações do Compilador
      shell: msys2 {0}
      run: |
        g++ --version
        echo "Build Type: ${{ matrix.build_type }}"
        
    - name: 🚀 Build Fast (Release)
      if: matrix.build_type == 'Release'
      shell: msys2 {0}
      run: |
        g++ -std=c++17 -O2 -DNDEBUG -Wall -Wextra main.cpp -o main_release.exe
        
    - name: 🐛 Build Debug
      if: matrix.build_type == 'Debug'
      shell: msys2 {0}
      run: |
        g++ -std=c++17 -g -O0 -Wall -Wextra main.cpp -o main_debug.exe
        
    - name: 🧪 Build Unit Tests
      shell: msys2 {0}
      run: |
        g++ -std=c++17 -g -O0 -Wall -Wextra test_main.cpp -o test_runner.exe
        
    - name: 🧪 Run Unit Tests
      shell: msys2 {0}
      run: |
        ./test_runner.exe
        
    - name: ✅ Teste Execução (Release)
      if: matrix.build_type == 'Release'
      shell: msys2 {0}
      run: |
        ./main_release.exe
        
    - name: ✅ Teste Execução (Debug)
      if: matrix.build_type == 'Debug'
      shell: msys2 {0}
      run: |
        ./main_debug.exe
        
    - name: 📦 Upload Artifact (Release)
      if: matrix.build_type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: windows-release-build
        path: main_release.exe
        retention-days: 30
        
    - name: 📦 Upload Artifact (Debug)
      if: matrix.build_type == 'Debug'
      uses: actions/upload-artifact@v4
      with:
        name: windows-debug-build
        path: main_debug.exe
        retention-days: 30

  code-quality:
    name: Análise de Código
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔍 Checkout código
      uses: actions/checkout@v4
      
    - name: 🔧 Install Clang Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy cppcheck g++
        
    - name: 🧪 Build and Run Unit Tests (Linux)
      run: |
        echo "=== Compilando e Executando Testes Unitários ==="
        g++ -std=c++17 -g -O0 -Wall -Wextra test_main.cpp -o test_runner
        ./test_runner
        
    - name: 🔍 Run cppcheck on main
      run: |
        cppcheck --enable=all --suppress=missingIncludeSystem --error-exitcode=0 main.cpp
        
    - name: 🔍 Run cppcheck on tests
      run: |
        cppcheck --enable=all --suppress=missingIncludeSystem --error-exitcode=0 test_main.cpp pointer_utils.h test_framework.h
        
    - name: 📊 Estatísticas do Código
      run: |
        echo "=== Estatísticas do Código ==="
        echo "Linhas de código:"
        wc -l main.cpp
        echo ""
        echo "Tamanho do arquivo:"
        ls -lh main.cpp
